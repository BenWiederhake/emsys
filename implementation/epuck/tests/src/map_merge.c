#include <assert.h>
#include <stdio.h>

#include "map_heap.h"

#define data_width 20
#define data_height 20

static FieldType types_empty[] = {
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
         /*|*/
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
         /*|*/
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
typedef char check_empty_length[(sizeof(types_empty) / sizeof(types_empty[0])
    == (data_width * data_height)) ? 1 : -1];

static FieldType types_init[] = {
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
         /*|*/
    0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,2,0,2,2,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,1,0,1,2,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
         /*|*/
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
typedef char check_types_length[(sizeof(types_init) / sizeof(types_init[0])
    == (data_width * data_height)) ? 1 : -1];

static FieldType types_patch[] = {
    1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
    0,2,2,1,0,0,0,0,0,0,0,0,0,0,1,0,
    0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,
    0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,
    2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
typedef FieldType check_patch_length[(sizeof(types_patch) / sizeof(types_patch[0])
    == (MAP_PROXIMITY_SIZE * MAP_PROXIMITY_SIZE)) ? 1 : -1];

static FieldType types_after_update[] = {
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
         /*|*/
    0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
    0,0,0,0,1,2,2,1,0,0,0,0,0,0,0,0,0,0,1,0,
    0,2,2,2,1,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,
    0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,2,0,2,2,2,1,2,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,
    0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,2,0,0,
    0,0,0,0,0,0,0,0,0,0,1,0,1,2,0,0,0,2,0,0,
    0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,2,2,0,0,0,1,1,0,
    0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
         /*|*/
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
typedef char check_types_afterwards_length[(sizeof(types_after_update) == sizeof(types_init)) ? 1 : -1];

static FieldType types_patched_empty[] = {
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
         /*|*/
    0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
    0,0,0,0,0,2,2,1,0,0,0,0,0,0,0,0,0,0,1,0,
    0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,
    0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,
    0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
         /*|*/
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
typedef char check_empty_afterwards_length[(sizeof(types_patched_empty) == sizeof(types_init)) ? 1 : -1];

static int run_case(FieldType* input, FieldType* patch, FieldType* expected) {
    int x, y, all_good;
    Map* m;
    Map* prox;

    /* Test setup */
    m = map_heap_alloc(data_width, data_height);
    for (y = 0; y < data_height; ++y) {
        for (x = 0; x < data_width; ++x) {
            map_set_field(m, x, y, input[x + y * data_width]);
        }
    }
    prox = map_heap_alloc(MAP_PROXIMITY_SIZE, MAP_PROXIMITY_SIZE);
    for (y = 0; y < MAP_PROXIMITY_SIZE; ++y) {
        for (x = 0; x < MAP_PROXIMITY_SIZE; ++x) {
            map_set_field(prox, x, y, patch[x + y * MAP_PROXIMITY_SIZE]);
        }
    }

    /* Run it. (Don't use this as a benchmark, x86 has caches and stuff
     * in contrast to PIC.) */
    map_merge(m, 4, 2, prox);

    printf("patched map: (ExpectedActual, ExpectedActual, ...)\n");
    all_good = 1;
    for (y = 0; y < data_height; ++y) {
        for (x = 0; x < data_width; ++x) {
            FieldType expect, actual;
            expect = expected[x + y * data_width];
            actual = map_get_field(m, x, y);
            printf("%d%d,", expect, map_get_field(m, x, y));
            all_good &= expect == actual;
        }
        printf("\n");
    }

    if (!all_good) {
        printf(" BAD\n");
    } else {
        printf(" GOOD\n");
    }
    map_heap_free(m);
    map_heap_free(prox);

    return all_good;
}

int main(void) {
    int all_good = 1;
    all_good &= run_case(types_empty, types_patch, types_patched_empty);
    all_good &= run_case(types_init, types_patch, types_after_update);
    printf("\tDONE\n");
    return !all_good;
}
